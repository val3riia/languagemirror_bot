#!/usr/bin/env python
# -*- coding: utf-8 -*-

"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ –≤ Language Mirror Bot.
–≠—Ç–æ –ø–æ–ª–µ–∑–Ω–æ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ admin_feedback –∏ —Å–∏—Å—Ç–µ–º—ã –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–æ–≤.
"""

import os
import sys
import random
import logging
from datetime import datetime, timedelta

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.DEBUG
)
logger = logging.getLogger(__name__)

def generate_timestamp():
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–ª—É—á–∞–π–Ω—É—é –≤—Ä–µ–º–µ–Ω–Ω—É—é –º–µ—Ç–∫—É –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π"""
    now = datetime.now()
    days_ago = random.randint(0, 7)
    hours_ago = random.randint(0, 23)
    minutes_ago = random.randint(0, 59)
    
    return now - timedelta(days=days_ago, hours=hours_ago, minutes=minutes_ago)

def add_test_feedback(count=10):
    """–î–æ–±–∞–≤–ª—è–µ—Ç —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏"""
    try:
        # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –º–æ–¥—É–ª–∏
        from models import db, User, Feedback
        from main import app
        
        # –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–∑—ã–≤–æ–≤
        ratings = ["helpful", "okay", "not_helpful"]
        
        # –í–µ—Å–∞ –¥–ª—è —Ä–µ–π—Ç–∏–Ω–≥–æ–≤, —á—Ç–æ–±—ã —Å–¥–µ–ª–∞—Ç—å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –±–æ–ª–µ–µ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–º
        # 60% –ø–æ–ª–µ–∑–Ω–æ, 30% –Ω–æ—Ä–º–∞–ª—å–Ω–æ, 10% –Ω–µ –ø–æ–ª–µ–∑–Ω–æ
        rating_weights = [0.6, 0.3, 0.1]
        
        # –ü—Ä–∏–º–µ—Ä—ã –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ —Ä–µ–π—Ç–∏–Ω–≥–∞
        comments = {
            "helpful": [
                "–û—á–µ–Ω—å –ø–æ–ª–µ–∑–Ω–æ! –£–∑–Ω–∞–ª –º–Ω–æ–≥–æ –Ω–æ–≤—ã—Ö —Å–ª–æ–≤.",
                "–û—Ç–ª–∏—á–Ω—ã–π —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–π –ø–∞—Ä—Ç–Ω–µ—Ä, –ø–æ–º–æ–≥ –º–Ω–µ —É–ª—É—á—à–∏—Ç—å –ø—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏–µ.",
                "–ü–æ–Ω—Ä–∞–≤–∏–ª–æ—Å—å –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –≥—Ä–∞–º–º–∞—Ç–∏–∫–∏, –≤—Å–µ –æ—á–µ–Ω—å –ø–æ–Ω—è—Ç–Ω–æ.",
                "–•–æ—Ä–æ—à–∏–π —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫, –¥–∞–µ—Ç –ø–æ–ª–µ–∑–Ω—É—é –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å.",
                "–ü–æ–º–æ–≥ –º–Ω–µ –ø—Ä–µ–æ–¥–æ–ª–µ—Ç—å —è–∑—ã–∫–æ–≤–æ–π –±–∞—Ä—å–µ—Ä.",
                "–û—Ç–ª–∏—á–Ω—ã–µ —Å—Ç–∞—Ç—å–∏ –ø–æ —Ç–µ–º–µ, –º–Ω–æ–≥–æ —É–∑–Ω–∞–ª –Ω–æ–≤–æ–≥–æ.",
                "–°—É–ø–µ—Ä! –ë—É–¥—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –¥–ª—è –ø—Ä–∞–∫—Ç–∏–∫–∏."
            ],
            "okay": [
                "–ù–µ–ø–ª–æ—Ö–æ, –Ω–æ —Ö–æ—Ç–µ–ª–æ—Å—å –±—ã –±–æ–ª—å—à–µ —Ç–µ–º –¥–ª—è –æ–±—Å—É–∂–¥–µ–Ω–∏—è.",
                "–ù–æ—Ä–º–∞–ª—å–Ω–æ, –Ω–æ –∏–Ω–æ–≥–¥–∞ –æ—Ç–≤–µ—Ç—ã —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–µ.",
                "–í —Ü–µ–ª–æ–º –ø–æ–ª–µ–∑–Ω–æ, –Ω–æ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –Ω–∞ –≥—Ä–∞–º–º–∞—Ç–∏–∫—É.",
                "–ü–æ–º–æ–≥–∞–µ—Ç, –Ω–æ —Ö–æ—Ç–µ–ª–æ—Å—å –±—ã –±–æ–ª—å—à–µ –∏–¥–∏–æ–º –∏ —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã—Ö —Ñ—Ä–∞–∑.",
                "–£–¥–æ–±–Ω–æ –¥–ª—è –ø—Ä–∞–∫—Ç–∏–∫–∏, –Ω–æ –∏–Ω–æ–≥–¥–∞ –Ω–µ —Å–æ–≤—Å–µ–º –ø–æ–Ω–∏–º–∞–µ—Ç –≤–æ–ø—Ä–æ—Å—ã."
            ],
            "not_helpful": [
                "–ù–µ –ø–æ–º–æ–≥–ª–æ –º–Ω–µ —Å –º–æ–µ–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∑–∞–¥–∞—á–µ–π.",
                "–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –æ—à–∏–±–æ–∫ –≤ –æ—Ç–≤–µ—Ç–∞—Ö.",
                "–ù–µ –ø–æ–Ω—Ä–∞–≤–∏–ª–∏—Å—å —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω—ã–µ —Å—Ç–∞—Ç—å–∏."
            ]
        }
        
        # –î–µ–º–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
        demo_users = [
            {"telegram_id": 123456789, "username": "language_learner1", "first_name": "–ò–≤–∞–Ω", "last_name": "–ü–µ—Ç—Ä–æ–≤"},
            {"telegram_id": 987654321, "username": "english_student", "first_name": "–ê–Ω–Ω–∞", "last_name": "–°–º–∏—Ä–Ω–æ–≤–∞"},
            {"telegram_id": 555555555, "username": "polyglot007", "first_name": "–ú–∞–∫—Å–∏–º", "last_name": "–ò–≤–∞–Ω–æ–≤"},
            {"telegram_id": 111222333, "username": "linguist", "first_name": "–ï–ª–µ–Ω–∞", "last_name": "–ö–æ–∑–ª–æ–≤–∞"},
            {"telegram_id": 444333222, "username": "word_lover", "first_name": "–ê–ª–µ–∫—Å–µ–π", "last_name": "–°–æ–∫–æ–ª–æ–≤"}
        ]
        
        with app.app_context():
            created_count = 0
            
            # –°–æ–∑–¥–∞–µ–º –∏–ª–∏ –ø–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            users = []
            for user_data in demo_users:
                user = User.query.filter_by(telegram_id=user_data["telegram_id"]).first()
                if not user:
                    user = User(
                        telegram_id=user_data["telegram_id"],
                        username=user_data["username"],
                        first_name=user_data["first_name"],
                        last_name=user_data["last_name"],
                        language_level="B1",  # –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                        created_at=datetime.now()
                    )
                    db.session.add(user)
                    db.session.commit()
                    logger.info(f"–°–æ–∑–¥–∞–Ω —Ç–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {user.username}")
                
                users.append(user)
            
            # –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–∑—ã–≤—ã
            for i in range(count):
                # –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                user = random.choice(users)
                
                # –í—ã–±–∏—Ä–∞–µ–º —Ä–µ–π—Ç–∏–Ω–≥ —Å —É—á–µ—Ç–æ–º –≤–µ—Å–æ–≤
                rating = random.choices(ratings, weights=rating_weights, k=1)[0]
                
                # –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–ª—è —ç—Ç–æ–≥–æ —Ä–µ–π—Ç–∏–Ω–≥–∞
                comment = random.choice(comments[rating])
                
                # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω—É—é –≤—Ä–µ–º–µ–Ω–Ω—É—é –º–µ—Ç–∫—É
                timestamp = generate_timestamp()
                
                # –°–æ–∑–¥–∞–µ–º –æ—Ç–∑—ã–≤
                feedback = Feedback(
                    user_id=user.id,
                    rating=rating,
                    comment=comment,
                    timestamp=timestamp
                )
                
                db.session.add(feedback)
                created_count += 1
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
            db.session.commit()
            
            return created_count
            
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ç–µ—Å—Ç–æ–≤–æ–π –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏: {e}")
        import traceback
        logger.error(traceback.format_exc())
        return 0

def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å–∫—Ä–∏–ø—Ç–∞"""
    print("\nüìä –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ –¥–ª—è Language Mirror Bot\n")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
    if not os.environ.get("DATABASE_URL"):
        print("‚ùå –û–®–ò–ë–ö–ê: –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è DATABASE_URL –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞")
        print("–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ URL –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö PostgreSQL –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è")
        sys.exit(1)
    
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –±–µ–∑ –≤–≤–æ–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    count = 10
    if len(sys.argv) > 1:
        try:
            count = int(sys.argv[1])
        except ValueError:
            print(f"–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –∞—Ä–≥—É–º–µ–Ω—Ç–µ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏: {sys.argv[1]}")
            print("–ë—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (10)")
    
    print(f"–î–æ–±–∞–≤–ª–µ–Ω–∏–µ {count} —Ç–µ—Å—Ç–æ–≤—ã—Ö –æ—Ç–∑—ã–≤–æ–≤...")
    created_count = add_test_feedback(count)
    
    if created_count > 0:
        print(f"‚úÖ –£—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ {created_count} —Ç–µ—Å—Ç–æ–≤—ã—Ö –æ—Ç–∑—ã–≤–æ–≤")
        print("\n–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–º–∞–Ω–¥—É /admin_feedback –≤ –±–æ—Ç–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞")
        print("—ç—Ç–∏—Ö –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å test_admin_feedback.py –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ Excel-–æ—Ç—á–µ—Ç–∞.")
    else:
        print("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –æ—Ç–∑—ã–≤—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.")
        sys.exit(1)

if __name__ == "__main__":
    main()